<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>My Account | Swarnim Jewels</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{--bg:#050505;--card:#111;--card2:#161616;--gold:#d4af37;--gold2:#f0d060;--text:#eee;--muted:#888;--border:rgba(212,175,55,.2);--err:#e57373;--ok:#81c784;}
    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{overflow-x:hidden;max-width:100%;}
    body{font-family:'Lato',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;}
    header{background:#0a0a0a;padding:18px 5%;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
    .logo{font-family:'Cinzel',serif;font-size:1.8rem;color:var(--gold);text-decoration:none;}
    nav{display:flex;gap:24px;align-items:center;}
    nav a{color:var(--text);text-decoration:none;font-size:.9rem;transition:color .3s;}
    nav a:hover{color:var(--gold);}
    .cart-wrap{position:relative;}
    .cart-badge{position:absolute;top:-6px;right:-8px;background:var(--gold);color:#000;width:18px;height:18px;border-radius:50%;font-size:.65rem;font-weight:700;display:none;align-items:center;justify-content:center;}

    .wrap{max-width:1100px;margin:0 auto;padding:50px 20px;flex:1;}
    .acct-head{display:flex;align-items:center;gap:24px;margin-bottom:40px;padding-bottom:28px;border-bottom:1px solid rgba(255,255,255,.06);}
    .avatar{width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,#c9a227,var(--gold2));display:flex;align-items:center;justify-content:center;font-family:'Cinzel',serif;font-size:1.8rem;color:#000;flex-shrink:0;}
    .acct-head h1{font-family:'Cinzel',serif;font-size:1.6rem;color:var(--gold);}
    .acct-head p{color:var(--muted);font-size:.88rem;margin-top:4px;}
    .btn-logout{margin-left:auto;padding:9px 20px;background:transparent;border:1px solid rgba(229,115,115,.4);border-radius:6px;color:var(--err);cursor:pointer;font-size:.82rem;transition:all .25s;}
    .btn-logout:hover{background:rgba(229,115,115,.1);}

    .tabs{display:flex;gap:4px;margin-bottom:28px;border-bottom:1px solid rgba(255,255,255,.06);overflow-x:auto;}
    .tab{padding:12px 22px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:.88rem;font-family:'Lato',sans-serif;white-space:nowrap;border-bottom:2px solid transparent;transition:all .25s;display:flex;align-items:center;gap:7px;}
    .tab:hover{color:var(--text);}
    .tab.active{color:var(--gold);border-bottom-color:var(--gold);}

    .panel{display:none;}
    .panel.active{display:block;}

    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:28px;}
    .card h2{font-family:'Cinzel',serif;font-size:1.1rem;color:var(--gold);margin-bottom:20px;display:flex;align-items:center;gap:10px;}
    .empty{text-align:center;padding:50px 20px;color:var(--muted);}
    .empty i{font-size:2.5rem;margin-bottom:16px;opacity:.4;display:block;}
    .empty a{color:var(--gold);text-decoration:none;}

    /* orders */
    .order-item{border:1px solid rgba(255,255,255,.06);border-radius:8px;padding:18px 20px;margin-bottom:14px;transition:border .25s;}
    .order-item:hover{border-color:rgba(212,175,55,.3);}
    .order-row{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;}
    .o-id{font-family:'Cinzel',serif;font-size:.85rem;color:var(--gold);}
    .o-date{font-size:.8rem;color:var(--muted);margin-top:3px;}
    .o-items{font-size:.82rem;color:#aaa;margin-top:6px;}
    .o-total{font-size:1rem;font-weight:700;color:var(--gold);text-align:right;}
    .badge{padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:700;text-transform:uppercase;}
    .bp{background:rgba(255,183,77,.15);color:#ffb74d;}
    .bc{background:rgba(129,199,132,.15);color:#81c784;}
    .bs{background:rgba(79,195,247,.15);color:#4fc3f7;}

    /* profile */
    .fgrid{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
    .fg{display:flex;flex-direction:column;gap:7px;}
    .fg label{font-size:.82rem;color:var(--muted);}
    .fg input{background:#1a1a1a;border:1px solid rgba(255,255,255,.08);border-radius:7px;color:var(--text);font-family:'Lato',sans-serif;font-size:.9rem;padding:11px 14px;outline:none;transition:border .25s;}
    .fg input:focus{border-color:var(--gold);}
    .fg input:disabled{opacity:.5;cursor:not-allowed;}
    .fg.full{grid-column:1/-1;}
    .btn-gold{padding:12px 28px;background:linear-gradient(135deg,#c9a227,var(--gold2));border:none;border-radius:7px;color:#000;font-family:'Cinzel',serif;font-size:.88rem;font-weight:700;cursor:pointer;transition:opacity .2s;display:inline-flex;align-items:center;gap:8px;}
    .btn-gold:hover{opacity:.88;}
    .btn-gold:disabled{opacity:.5;cursor:not-allowed;}
    .btn-outline{padding:12px 22px;background:transparent;border:1px solid var(--border);border-radius:7px;color:var(--gold);font-size:.88rem;cursor:pointer;display:inline-flex;align-items:center;gap:7px;transition:all .25s;}
    .btn-outline:hover{background:rgba(212,175,55,.08);}
    .arow{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:22px;}
    .divider{border-top:1px solid rgba(255,255,255,.06);margin:28px 0;}

    /* addresses */
    .agrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;}
    .acard{background:var(--card2);border:1px solid rgba(255,255,255,.06);border-radius:8px;padding:18px;position:relative;transition:border .25s;}
    .acard.def{border-color:rgba(212,175,55,.4);}
    .acard:hover{border-color:rgba(212,175,55,.25);}
    .atag{position:absolute;top:12px;right:12px;padding:3px 8px;background:rgba(212,175,55,.12);color:var(--gold);border-radius:4px;font-size:.7rem;font-weight:700;}
    .aname{font-weight:700;margin-bottom:6px;}
    .atext{font-size:.85rem;color:var(--muted);line-height:1.6;}
    .aacts{margin-top:12px;display:flex;gap:10px;}
    .btn-sm{padding:6px 14px;border-radius:5px;font-size:.78rem;cursor:pointer;border:none;transition:all .2s;}
    .btn-del{background:rgba(229,115,115,.1);color:var(--err);}
    .btn-del:hover{background:rgba(229,115,115,.2);}
    .add-addr{background:rgba(212,175,55,.06);border:1px dashed rgba(212,175,55,.3);border-radius:8px;padding:40px;text-align:center;cursor:pointer;color:var(--muted);transition:all .25s;}
    .add-addr:hover{background:rgba(212,175,55,.1);color:var(--gold);}
    .add-addr i{font-size:1.5rem;margin-bottom:8px;display:block;}

    /* wishlist */
    .wgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;}
    .witem{background:var(--card2);border:1px solid rgba(255,255,255,.06);border-radius:8px;overflow:hidden;transition:border .25s;}
    .witem:hover{border-color:rgba(212,175,55,.25);}
    .wimg{width:100%;height:150px;object-fit:cover;}
    .winfo{padding:12px;}
    .wname{font-size:.85rem;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .wprice{color:var(--gold);font-size:.9rem;font-weight:700;}
    .wacts{padding:10px 12px;display:flex;gap:8px;border-top:1px solid rgba(255,255,255,.05);}
    .btn-add{background:rgba(212,175,55,.12);color:var(--gold);}
    .btn-add:hover{background:rgba(212,175,55,.22);}

    /* inline alerts */
    .ialert{padding:10px 14px;border-radius:6px;font-size:.82rem;margin-bottom:16px;display:none;}
    .ialert.show{display:block;}
    .ialert.ok{background:rgba(129,199,132,.1);border:1px solid rgba(129,199,132,.3);color:var(--ok);}
    .ialert.err{background:rgba(229,115,115,.1);border:1px solid rgba(229,115,115,.3);color:var(--err);}

    /* modal */
    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:9999;align-items:center;justify-content:center;padding:20px;}
    .overlay.open{display:flex;}
    .modal{background:#111;border:1px solid var(--border);border-radius:12px;padding:36px;width:100%;max-width:480px;}
    .modal h3{font-family:'Cinzel',serif;color:var(--gold);margin-bottom:20px;}
    .mfoot{display:flex;gap:12px;margin-top:20px;}

    @keyframes spin{to{transform:rotate(360deg);}}
    .spinner{width:14px;height:14px;border:2px solid rgba(0,0,0,.3);border-top-color:#000;border-radius:50%;animation:spin .6s linear infinite;}

    footer{text-align:center;padding:24px;color:var(--muted);font-size:.8rem;border-top:1px solid rgba(255,255,255,.05);}
    footer a{color:var(--gold);text-decoration:none;}

    @media(max-width:640px){
      .fgrid{grid-template-columns:1fr;}
      .fg.full{grid-column:1;}
      .acct-head{flex-wrap:wrap;}
      .btn-logout{margin-left:0;}
      .tabs{gap:0;}
      .tab{padding:10px 14px;font-size:.8rem;}
    }
  </style>
</head>
<body>

<header>
  <a href="index.html" class="logo">SWARNIM</a>
  <nav>
    <a href="index.html"><i class="fa-solid fa-home"></i> Home</a>
    <a href="about-us.html"><i class="fa-solid fa-info-circle"></i> About</a>
    <a href="contact.html"><i class="fa-solid fa-envelope"></i> Contact</a>
    <a class="cart-wrap" href="cart.html">
      <i class="fa-solid fa-shopping-cart"></i> Cart
      <span class="cart-badge cart-count">0</span>
    </a>
    <a id="accountNavBtn" href="account.html"><i class="fa-solid fa-user-check"></i> Account</a>
  </nav>
</header>

<div class="wrap">

  <div class="acct-head">
    <div class="avatar" id="avatarLetter">?</div>
    <div>
      <h1 id="welcomeName">Loading…</h1>
      <p id="welcomeEmail"></p>
    </div>
    <button class="btn-logout" onclick="handleLogout()">
      <i class="fa-solid fa-right-from-bracket"></i> Sign Out
    </button>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('orders',this)"><i class="fa-solid fa-box"></i> Orders</button>
    <button class="tab" onclick="switchTab('profile',this)"><i class="fa-solid fa-user-pen"></i> Profile</button>
    <button class="tab" onclick="switchTab('addresses',this)"><i class="fa-solid fa-location-dot"></i> Addresses</button>
    <button class="tab" onclick="switchTab('wishlist',this)"><i class="fa-solid fa-heart"></i> Wishlist</button>
  </div>

  <!-- ORDERS -->
  <div class="panel active" id="panel-orders">
    <div class="card">
      <h2><i class="fa-solid fa-box"></i> My Orders</h2>
      <div id="ordersLoading" style="text-align:center;padding:30px;color:var(--muted)">
        <i class="fa-solid fa-spinner fa-spin"></i> Loading orders…
      </div>
      <div id="ordersList"></div>
    </div>
  </div>

  <!-- PROFILE -->
  <div class="panel" id="panel-profile">
    <div class="card">
      <h2><i class="fa-solid fa-user-pen"></i> Personal Information</h2>
      <div class="ialert" id="profileAlert"></div>
      <div class="fgrid">
        <div class="fg full"><label>Full Name</label><input type="text" id="profileName"></div>
        <div class="fg"><label>Email</label><input type="email" id="profileEmail" disabled></div>
        <div class="fg"><label>Phone</label><input type="tel" id="profilePhone" placeholder="+91 98765 43210"></div>
      </div>
      <div class="arow">
        <button class="btn-gold" id="saveProfileBtn" onclick="saveProfile()">
          <i class="fa-solid fa-floppy-disk"></i> Save Changes
        </button>
      </div>
      <div class="divider"></div>
      <h2><i class="fa-solid fa-key"></i> Change Password</h2>
      <div class="ialert" id="pwdAlert"></div>
      <div class="fgrid">
        <div class="fg full"><label>Current Password</label><input type="password" id="currentPwd" placeholder="Enter current password"></div>
        <div class="fg"><label>New Password</label><input type="password" id="newPwd" placeholder="Minimum 6 characters"></div>
        <div class="fg"><label>Confirm New Password</label><input type="password" id="confirmPwd" placeholder="Repeat new password"></div>
      </div>
      <div class="arow">
        <button class="btn-gold" id="savePwdBtn" onclick="savePassword()">
          <i class="fa-solid fa-lock"></i> Update Password
        </button>
      </div>
    </div>
  </div>

  <!-- ADDRESSES -->
  <div class="panel" id="panel-addresses">
    <div class="card">
      <h2><i class="fa-solid fa-location-dot"></i> Saved Addresses</h2>
      <div id="addrLoading" style="text-align:center;padding:30px;color:var(--muted)">
        <i class="fa-solid fa-spinner fa-spin"></i> Loading addresses…
      </div>
      <div class="agrid" id="addrGrid"></div>
    </div>
  </div>

  <!-- WISHLIST -->
  <div class="panel" id="panel-wishlist">
    <div class="card">
      <h2><i class="fa-solid fa-heart"></i> My Wishlist</h2>
      <div id="wishContent"></div>
    </div>
  </div>

</div><!-- /wrap -->

<!-- Add Address Modal -->
<div class="overlay" id="addrModal">
  <div class="modal">
    <h3><i class="fa-solid fa-location-dot"></i> Add Address</h3>
    <div class="fgrid">
      <div class="fg full"><label>Full Name</label><input type="text" id="m_name" placeholder="Recipient name"></div>
      <div class="fg full"><label>Address Line</label><input type="text" id="m_line" placeholder="House no, street, area"></div>
      <div class="fg"><label>City</label><input type="text" id="m_city" placeholder="City"></div>
      <div class="fg"><label>State</label><input type="text" id="m_state" placeholder="State"></div>
      <div class="fg"><label>PIN Code</label><input type="text" id="m_pin" placeholder="560001"></div>
      <div class="fg"><label>Phone</label><input type="tel" id="m_phone" placeholder="+91 98765 43210"></div>
    </div>
    <div class="mfoot">
      <button class="btn-outline" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
      <button class="btn-gold" id="saveAddrBtn" onclick="saveAddress()" style="flex:2">
        <i class="fa-solid fa-floppy-disk"></i> Save Address
      </button>
    </div>
  </div>
</div>

<footer>&copy; 2026 Swarnim Jewels &middot; <a href="privacy-policy.html">Privacy</a> &middot; <a href="contact.html">Support</a></footer>

<script src="shopping-cart.js"></script>
<script src="user-system.js"></script>
<script>
  // Redirect if not logged in — wrapped in else so nothing runs after redirect
  if (!UserSystem.isLoggedIn()) {
    window.location.href = 'login.html?redirect=account.html';
  } else {

  const user = UserSystem.getUser();

  // ── XSS ESCAPE ────────────────────────────────────────────
  function esc(s) {
    return String(s == null ? '' : s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  // ── HEADER ────────────────────────────────────────────────
  function populateHeader() {
    if (!user) return;
    document.getElementById('avatarLetter').textContent = (user.name || '?').charAt(0).toUpperCase();
    document.getElementById('welcomeName').textContent  = 'Hi, ' + (user.name || 'there') + '!';
    document.getElementById('welcomeEmail').textContent = user.email || '';
  }

  // ── TABS ──────────────────────────────────────────────────
  function switchTab(name, btn) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('panel-' + name).classList.add('active');
    btn.classList.add('active');
    if (name === 'addresses' && !addrLoaded) loadAddresses();
    if (name === 'wishlist')  renderWishlist();
  }

  // ── LOGOUT ────────────────────────────────────────────────
  async function handleLogout() {
    if (!confirm('Sign out of your account?')) return;
    await UserSystem.logout();
  }

  // ── ORDERS ────────────────────────────────────────────────
  async function loadOrders() {
    let result;
    try { result = await UserSystem.getOrders(); }
    catch(e) { result = { success:false, error:'Network error.' }; }

    document.getElementById('ordersLoading').style.display = 'none';
    const el = document.getElementById('ordersList');

    if (!result.success || !result.orders?.length) {
      el.innerHTML = `<div class="empty"><i class="fa-solid fa-box-open"></i>
        <p>${result.error ? esc(result.error) : 'No orders yet.'}</p>
        <p style="margin-top:10px"><a href="index.html">Start shopping →</a></p></div>`;
      return;
    }

    el.innerHTML = result.orders.map(o => {
      const st  = (o.status||'Pending').toLowerCase();
      const cls = st==='completed'?'bc':st==='shipped'?'bs':'bp';
      return `<div class="order-item"><div class="order-row">
        <div>
          <div class="o-id"># ${esc(o.orderId)}</div>
          <div class="o-date">${esc(o.date)}</div>
          <div class="o-items">${esc(o.items)}</div>
        </div>
        <div style="text-align:right">
          <div class="o-total">₹${Number(o.total||0).toLocaleString('en-IN')}</div>
          <span class="badge ${cls}" style="display:inline-block;margin-top:6px">${esc(o.status||'Pending')}</span>
        </div>
      </div></div>`;
    }).join('');
  }

  // ── PROFILE ───────────────────────────────────────────────
  function loadProfile() {
    if (!user) return;
    document.getElementById('profileName').value  = user.name  || '';
    document.getElementById('profileEmail').value = user.email || '';
    document.getElementById('profilePhone').value = user.phone || '';
  }

  function showAlert(id, msg, type='ok') {
    const el = document.getElementById(id);
    el.className = 'ialert show ' + type;
    el.textContent = (type==='ok'?'✅ ':'❌ ') + msg;
    setTimeout(() => { el.className='ialert'; el.textContent=''; }, 3500);
  }

  async function saveProfile() {
    const btn   = document.getElementById('saveProfileBtn');
    const name  = document.getElementById('profileName').value.trim();
    const phone = document.getElementById('profilePhone').value.trim();
    if (!name) { showAlert('profileAlert','Name is required.','err'); return; }
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div> Saving…';
    try {
      const r = await UserSystem.updateProfile({ name, phone });
      if (r.success) {
        showAlert('profileAlert','Profile updated successfully!');
        document.getElementById('avatarLetter').textContent = name.charAt(0).toUpperCase();
        document.getElementById('welcomeName').textContent  = 'Hi, ' + name.split(' ')[0] + '!';
      } else {
        showAlert('profileAlert', r.error || 'Update failed.', 'err');
      }
    } catch(e) { showAlert('profileAlert','Network error.','err'); }
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save Changes';
  }

  async function savePassword() {
    const btn  = document.getElementById('savePwdBtn');
    const cur  = document.getElementById('currentPwd').value;
    const nw   = document.getElementById('newPwd').value;
    const conf = document.getElementById('confirmPwd').value;
    if (!cur || !nw || !conf) { showAlert('pwdAlert','Please fill all password fields.','err'); return; }
    if (nw !== conf)           { showAlert('pwdAlert','Passwords do not match.','err'); return; }
    if (nw.length < 6)         { showAlert('pwdAlert','New password must be at least 6 characters.','err'); return; }
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div> Updating…';
    try {
      const r = await UserSystem.changePassword({ currentPassword: cur, newPassword: nw });
      if (r.success) {
        showAlert('pwdAlert','Password updated!');
        // Clear fields only on success
        ['currentPwd','newPwd','confirmPwd'].forEach(id => document.getElementById(id).value='');
      } else {
        showAlert('pwdAlert', r.error || 'Failed to update.', 'err');
      }
    } catch(e) { showAlert('pwdAlert','Network error.','err'); }
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-lock"></i> Update Password';
  }

  // ── ADDRESSES ─────────────────────────────────────────────
  let addrLoaded = false;
  let addrList   = [];

  async function loadAddresses() {
    addrLoaded = true;
    let result;
    try { result = await UserSystem.getAddresses(); }
    catch(e) { result = { success:false, addresses:[] }; }
    document.getElementById('addrLoading').style.display = 'none';
    addrList = (result.success && result.addresses) ? result.addresses : [];
    renderAddresses();
  }

  function renderAddresses() {
    const grid = document.getElementById('addrGrid');
    let html = addrList.map((a, i) => `
      <div class="acard ${i===0?'def':''}">
        ${i===0?'<span class="atag">Default</span>':''}
        <div class="aname">${esc(a.name)}</div>
        <div class="atext">
          ${esc(a.line)}<br>
          ${esc(a.city)}, ${esc(a.state)} - ${esc(a.pin)}
          ${a.phone ? '<br>'+esc(a.phone) : ''}
        </div>
        <div class="aacts">
          <button class="btn-sm btn-del" onclick="deleteAddress(${i})">
            <i class="fa-solid fa-trash"></i> Remove
          </button>
        </div>
      </div>`).join('');

    html += `<div class="add-addr" onclick="openModal()">
      <i class="fa-solid fa-plus"></i><div>Add New Address</div></div>`;
    grid.innerHTML = html;
  }

  function openModal()  { document.getElementById('addrModal').classList.add('open'); }
  function closeModal() {
    document.getElementById('addrModal').classList.remove('open');
    // Clear fields so stale data doesn't appear on next open
    ['m_name','m_line','m_city','m_state','m_pin','m_phone'].forEach(id => document.getElementById(id).value = '');
    // Reset button in case it was left in loading state
    const btn = document.getElementById('saveAddrBtn');
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save Address';
  }

  // Escape key and overlay click close modal
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
  document.getElementById('addrModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
  });

  async function saveAddress() {
    const btn  = document.getElementById('saveAddrBtn');
    const addr = {
      name:  document.getElementById('m_name').value.trim(),
      line:  document.getElementById('m_line').value.trim(),
      city:  document.getElementById('m_city').value.trim(),
      state: document.getElementById('m_state').value.trim(),
      pin:   document.getElementById('m_pin').value.trim(),
      phone: document.getElementById('m_phone').value.trim()
    };
    if (!addr.name || !addr.line || !addr.city || !addr.pin) {
      alert('Please fill Name, Address Line, City and PIN Code.'); return;
    }
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div> Saving…';
    try {
      const r = await UserSystem.saveAddress(addr);
      if (r.success) {
        addrList = r.addresses || [...addrList, addr];
        renderAddresses();
        closeModal();
        // Clear fields only on success
        ['m_name','m_line','m_city','m_state','m_pin','m_phone'].forEach(id => document.getElementById(id).value='');
      } else {
        alert(r.error || 'Failed to save address.');
      }
    } catch(e) { alert('Network error. Please try again.'); }
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save Address';
  }

  async function deleteAddress(idx) {
    if (!confirm('Remove this address?')) return;
    const prev = [...addrList];
    addrList.splice(idx, 1);
    renderAddresses(); // optimistic
    try {
      const r = await UserSystem.replaceAddresses(addrList);
      if (!r.success) { addrList = prev; renderAddresses(); alert(r.error || 'Failed to delete.'); }
    } catch(e) { addrList = prev; renderAddresses(); alert('Network error.'); }
  }

  // ── WISHLIST ──────────────────────────────────────────────
  function renderWishlist() {
    const list = UserSystem.getWishlist();
    const el   = document.getElementById('wishContent');
    if (!list.length) {
      el.innerHTML = `<div class="empty"><i class="fa-solid fa-heart-crack"></i>
        <p>Your wishlist is empty.</p>
        <p style="margin-top:10px"><a href="index.html">Explore products →</a></p></div>`;
      return;
    }
    el.innerHTML = '<div class="wgrid">' + list.map(item => `
      <div class="witem">
        <img class="wimg"
          src="${esc(item.image||'')}"
          onerror="this.src='https://placehold.co/200x150/111/444?text=No+Image'"
          alt="${esc(item.name)}" loading="lazy">
        <div class="winfo">
          <div class="wname">${esc(item.name)}</div>
          <div class="wprice">₹${Number(item.price||0).toLocaleString('en-IN')}</div>
        </div>
        <div class="wacts">
          <button class="btn-sm btn-add" onclick="addToCart('${esc(item.id)}',this)">
            <i class="fa-solid fa-cart-plus"></i> Add
          </button>
          <button class="btn-sm btn-del" onclick="removeWish('${esc(item.id)}')">
            <i class="fa-solid fa-heart-crack"></i>
          </button>
        </div>
      </div>`).join('') + '</div>';
  }

  function removeWish(id) { UserSystem.toggleWishlist({ id }); renderWishlist(); }

  function addToCart(id, btn) {
    const item = UserSystem.getWishlist().find(i => String(i.id) === String(id));
    if (!item) return;
    if (window.ShoppingCart?.addItem) {
      ShoppingCart.addItem(item);
      btn.innerHTML = '✅ Added';
      btn.disabled = true;
      setTimeout(() => { btn.innerHTML = '<i class="fa-solid fa-cart-plus"></i> Add'; btn.disabled = false; }, 1500);
    } else {
      alert('Cart not loaded. Please refresh.');
    }
  }

  // ── INIT ──────────────────────────────────────────────────
  populateHeader();
  loadProfile();
  loadOrders();

  } // end else (isLoggedIn)
</script>
</body>
</html>
